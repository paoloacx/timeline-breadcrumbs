<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breadcrumbs Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: repeating-linear-gradient(
                0deg,
                #c0c0c0,
                #c0c0c0 1px,
                #d0d0d0 1px,
                #d0d0d0 2px
            );
            padding: 20px;
            padding-bottom: 150px;
        }

        body.dark-mode {
            background: repeating-linear-gradient(
                0deg,
                #2a2a2a,
                #2a2a2a 1px,
                #3a3a3a 1px,
                #3a3a3a 2px
            );
            color: #e0e0e0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .mac-window {
            background: white;
            border: 3px solid #000;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .dark-mode .mac-window {
            background: #333;
            color: #e0e0e0;
            border-color: #666;
        }

        .mac-title-bar {
            background: #000;
            color: white;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .dark-mode .mac-title-bar {
            background: #444;
        }

        .mac-content {
            padding: 20px;
        }

        .mac-button {
            background: #ddd;
            border: 3px outset #fff;
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .mac-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .dark-mode .mac-button {
            background: #555;
            color: #e0e0e0;
            border-color: #777;
        }

        .mac-button:hover {
            background: #eee;
        }

        .dark-mode .mac-button:hover {
            background: #666;
        }

        .mac-button:active {
            border-style: inset;
        }

        .mac-button-primary {
            background: #000;
            color: white;
        }

        .dark-mode .mac-button-primary {
            background: #666;
        }

        .mac-input,
        .mac-textarea {
            width: 100%;
            border: 2px inset #999;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .dark-mode .mac-input,
        .dark-mode .mac-textarea {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .mac-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .mac-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
        }

        /* Timeline styles */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #000;
        }

        .dark-mode .timeline-line {
            background: #666;
        }

        .day-block {
            margin-bottom: 30px;
            position: relative;
        }

        .day-header {
            background: #000;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 3px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            transition: all 0.3s;
        }

        .dark-mode .day-header {
            background: #444;
            border-color: #666;
        }

        .day-header::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: #000;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 3px #000;
        }

        .dark-mode .day-header::before {
            background: #666;
            border-color: #333;
            box-shadow: 0 0 0 3px #666;
        }

        .day-header:hover {
            background: #333;
        }

        .dark-mode .day-header:hover {
            background: #555;
        }

        .day-content {
            padding-top: 12px;
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .day-content.collapsed {
            max-height: 0;
            padding-top: 0;
        }

        .breadcrumb-entry {
            border: 3px ridge #999;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s;
            min-height: 120px;
            background: white; /* Fondo blanco para mejor contraste */
        }

        .dark-mode .breadcrumb-entry {
            border-color: #666;
            background: #444; /* Fondo oscuro en modo oscuro */
        }

        .breadcrumb-entry.manual-entry {
            background: white; /* Mantener blanco para mejor visibilidad */
        }

        .dark-mode .breadcrumb-entry.manual-entry {
            background: #444;
        }

        .breadcrumb-entry.time-event {
            background: #fff8e1; /* Beige muy claro para mejor contraste */
            min-height: 140px;
        }

        .dark-mode .breadcrumb-entry.time-event {
            background: #5a5340;
        }

        .breadcrumb-entry.time-event.short-duration {
            min-height: 140px;
        }

        .breadcrumb-entry.time-event.medium-duration {
            min-height: 160px;
            background: #ffecb3; /* Beige m√°s claro para duraci√≥n media */
        }

        .dark-mode .breadcrumb-entry.time-event.medium-duration {
            background: #4d4630;
        }

        .breadcrumb-entry.time-event.long-duration {
            min-height: 180px;
            background: #ffd54f; /* Beige m√°s claro para duraci√≥n larga */
        }

        .dark-mode .breadcrumb-entry.time-event.long-duration {
            background: #3d3820;
        }

        .breadcrumb-entry.track-event {
            background: repeating-linear-gradient(
                45deg,
                #f5f5f5,
                #f5f5f5 10px,
                #e8e8e8 10px,
                #e8e8e8 20px
            ); /* Patr√≥n gris m√°s claro */
            min-height: 140px;
        }

        .dark-mode .breadcrumb-entry.track-event {
            background: repeating-linear-gradient(
                45deg,
                #555,
                #555 10px,
                #444 10px,
                #444 20px
            );
        }

        .breadcrumb-entry.spent-event {
            background: #e8f5e8; /* Verde muy claro para gastos */
            min-height: 120px;
        }

        .dark-mode .breadcrumb-entry.spent-event {
            background: #3a4a3a;
        }

        .breadcrumb-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .breadcrumb-time {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 8px;
            color: #666;
        }

        .dark-mode .breadcrumb-time {
            color: #aaa;
        }

        .breadcrumb-time-range {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .dark-mode .breadcrumb-time-range {
            color: #999;
        }

        .breadcrumb-content {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 140px);
        }

        .breadcrumb-note {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
            max-height: 80px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            word-wrap: break-word;
        }

        .breadcrumb-note.expanded {
            max-height: 1000px;
        }

        .read-more-btn {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            text-decoration: underline;
            margin-top: 5px;
        }

        .dark-mode .read-more-btn {
            color: #4d94ff;
        }

        .breadcrumb-meta {
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mini-map {
            width: 100%;
            height: 200px;
            border: 3px solid #000;
            margin-top: 12px;
            background: #e0e0e0;
        }

        .dark-mode .mini-map {
            border-color: #666;
            background: #444;
        }

        .breadcrumb-preview {
            display: none;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .breadcrumb-preview.show-preview {
            display: flex;
        }

        .preview-item {
            width: 100px;
            height: 100px;
            border: 2px solid #000;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .dark-mode .preview-item {
            border-color: #666;
        }

        .preview-item.hidden {
            display: none;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-map {
            width: 120px;
            height: 120px;
            border: 2px solid #000;
            cursor: pointer;
            position: absolute;
            right: 16px;
            top: 16px;
        }

        .dark-mode .preview-map {
            border-color: #666;
        }

        .edit-button {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 6px 12px;
            font-size: 12px;
        }

        .audio-button {
            position: absolute;
            bottom: 12px;
            right: 80px;
            padding: 6px 12px;
            font-size: 12px;
        }

        .audio-player {
            margin-top: 10px;
            width: 100%;
        }

        .image-preview {
            display: inline-block;
            width: 80px;
            height: 80px;
            border: 2px solid #000;
            margin: 4px;
            position: relative;
        }

        .dark-mode .image-preview {
            border-color: #666;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: #000;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            border-radius: 50%;
        }

        .dark-mode .image-remove {
            background: #666;
            border-color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
        }

        .hidden {
            display: none !important;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            color: white;
            padding: 12px 20px;
            border-top: 3px solid #666;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.3);
        }

        .dark-mode .footer {
            background: #333;
        }

        .footer-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .footer-filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .footer .mac-button {
            margin: 0;
            font-size: 12px;
            padding: 6px 12px;
        }

        .footer .search-input,
        .footer .filter-select {
            font-size: 12px;
            padding: 6px;
            border: 2px inset #999;
            font-family: 'Courier New', monospace;
        }

        .dark-mode .footer .search-input,
        .dark-mode .footer .filter-select {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .footer .search-input {
            width: 200px;
        }

        .footer .filter-select {
            min-width: 120px;
        }

        .delete-button {
            background: #ff6b6b;
            color: white;
            border-color: #ff0000;
        }

        .dark-mode .delete-button {
            background: #993333;
            border-color: #662222;
        }

        .chevron {
            transition: transform 0.3s;
        }

        .chevron.collapsed {
            transform: rotate(180deg);
        }

        /* Edit form styles */
        .edit-form-container {
            margin-top: 10px;
            margin-bottom: 20px;
            border: 3px solid #666 !important;
        }

        .dark-mode .edit-form-container {
            border-color: #888 !important;
        }

        /* Time Event Styles */
        .time-event-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ccc;
        }

        .duration-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .duration-option {
            background: white;
            border: 3px outset #999;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode .duration-option {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .duration-option:hover {
            background: #f0f0f0;
        }

        .dark-mode .duration-option:hover {
            background: #555;
        }

        .duration-option.selected {
            background: #000;
            color: white;
            border-style: inset;
        }

        .dark-mode .duration-option.selected {
            background: #666;
        }

        .activity-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .activity-option {
            background: white;
            border: 3px outset #999;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode .activity-option {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .activity-option:hover {
            background: #f0f0f0;
        }

        .dark-mode .activity-option:hover {
            background: #555;
        }

        .activity-option.selected {
            background: #000;
            color: white;
            border-style: inset;
        }

        .dark-mode .activity-option.selected {
            background: #666;
        }

        .activity-icon {
            font-size: 18px;
            display: block;
            margin-bottom: 4px;
        }

        .time-event-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #e6f7ff;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-size: 12px;
        }

        .dark-mode .time-event-indicator {
            background: #2a4a5a;
        }

        /* Track Event Styles */
        .track-category-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .track-category-option {
            background: white;
            border: 3px outset #999;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode .track-category-option {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .track-category-option:hover {
            background: #f0f0f0;
        }

        .dark-mode .track-category-option:hover {
            background: #555;
        }

        .track-category-option.selected {
            background: #000;
            color: white;
            border-style: inset;
        }

        .dark-mode .track-category-option.selected {
            background: #666;
        }

        .track-item-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .track-item-option {
            background: white;
            border: 3px outset #999;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode .track-item-option {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .track-item-option:hover {
            background: #f0f0f0;
        }

        .dark-mode .track-item-option:hover {
            background: #555;
        }

        .track-item-option.selected {
            background: #000;
            color: white;
            border-style: inset;
        }

        .dark-mode .track-item-option.selected {
            background: #666;
        }

        /* Mood selector styles */
        .mood-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .mood-option {
            background: white;
            border: 3px outset #999;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .dark-mode .mood-option {
            background: #444;
            border-color: #666;
        }

        .mood-option:hover {
            background: #f0f0f0;
        }

        .dark-mode .mood-option:hover {
            background: #555;
        }

        .mood-option.selected {
            background: #000;
            color: white;
            border-style: inset;
        }

        .dark-mode .mood-option.selected {
            background: #666;
        }

        /* Settings Styles */
        .settings-panel {
            padding: 15px;
            background: #f9f9f9;
            border: 2px solid #ccc;
            margin-bottom: 15px;
        }

        .dark-mode .settings-panel {
            background: #444;
            border-color: #666;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .duration-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .duration-config label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .duration-config input {
            width: 60px;
            padding: 4px;
            border: 2px inset #999;
            font-family: 'Courier New', monospace;
        }

        .dark-mode .duration-config input {
            background: #444;
            color: #e0e0e0;
            border-color: #666;
        }

        .track-category-config {
            margin-bottom: 15px;
            padding: 10px;
            border: 2px solid #ddd;
        }

        .dark-mode .track-category-config {
            border-color: #666;
        }

        .track-item-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Stats Styles */
        .stats-panel {
            max-height: 70vh;
            overflow-y: auto;
        }

        .stats-category {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #ddd;
            background: #f9f9f9;
        }

        .dark-mode .stats-category {
            background: #444;
            border-color: #666;
        }

        .stats-category h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .dark-mode .stats-category h3 {
            color: #e0e0e0;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px;
            background: white;
            border: 1px solid #ddd;
        }

        .dark-mode .stats-item {
            background: #555;
            border-color: #666;
        }

        .stats-item-name {
            font-weight: bold;
        }

        .stats-item-value {
            color: #0066cc;
        }

        .dark-mode .stats-item-value {
            color: #4d94ff;
        }

        /* Audio recording styles */
        .audio-recorder {
            margin-top: 10px;
            padding: 10px;
            border: 2px dashed #999;
            background: #f9f9f9;
        }

        .dark-mode .audio-recorder {
            border-color: #666;
            background: #444;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Spent event styles */
        .spent-amount {
            font-weight: bold;
            color: #006400;
            margin-left: 8px;
        }

        .dark-mode .spent-amount {
            color: #4caf50;
        }

        .spent-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        /* Toggle preview button */
        .toggle-preview-btn {
            background: #ddd;
            border: 2px outset #fff;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }

        .dark-mode .toggle-preview-btn {
            background: #555;
            border-color: #777;
            color: #e0e0e0;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border: 3px solid #000;
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .dark-mode .modal-content {
            background: #333;
            border-color: #666;
        }

        .image-modal {
            max-width: 80%;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }

        .map-modal {
            width: 80%;
            height: 80%;
        }

        #modal-map {
            width: 100%;
            height: 100%;
        }

        .modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #000;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .dark-mode .modal-close {
            background: #666;
            border-color: #333;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #000;
            color: white;
            border: 2px solid #666;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
        }

        .dark-mode .notification {
            background: #333;
        }

        .notification.error {
            background: #8B0000;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        /* Mood display in entries */
        .mood-display {
            font-size: 18px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <button class="mac-button theme-toggle" onclick="toggleTheme()">üåô</button>

    <div class="container">
        <div class="mac-window">
            <div class="mac-title-bar">Breadcrumbs Timeline</div>
            <div class="mac-content">
                <button class="mac-button mac-button-primary" onclick="toggleForm()">üçû Breadcrumb</button>
                <button class="mac-button" onclick="toggleTimeEventForm()">‚è∞ Time Log</button>
                <button class="mac-button" onclick="toggleTrackForm()">üìì Track</button>
                <button class="mac-button" onclick="toggleSpentForm()">üí∞ Spent</button>
            </div>
        </div>

        <!-- Forms will be inserted here when editing -->
        <div id="edit-forms-container"></div>

        <div class="mac-window hidden" id="form-window">
            <div class="mac-title-bar">New Breadcrumb</div>
            <div class="mac-content">
                <label class="mac-label">Note:</label>
                <textarea class="mac-textarea" id="note-input" placeholder="What's happening?"></textarea>

                <label class="mac-label">üòä Mood:</label>
                <div class="mood-selector" id="mood-selector">
                    <div class="mood-option" onclick="selectMood('üòä')">üòä</div>
                    <div class="mood-option" onclick="selectMood('üò¢')">üò¢</div>
                    <div class="mood-option" onclick="selectMood('üò†')">üò†</div>
                    <div class="mood-option" onclick="selectMood('üò¥')">üò¥</div>
                    <div class="mood-option" onclick="selectMood('üòé')">üòé</div>
                </div>

                <label class="mac-label">üìç Location:</label>
                <input type="text" class="mac-input" id="location-input" placeholder="Place">
                <button class="mac-button" onclick="getGPS()" id="gps-btn">üåç Use GPS</button>
                <div id="form-map" class="mini-map hidden"></div>

                <label class="mac-label">‚òÅÔ∏è Weather:</label>
                <input type="text" class="mac-input" id="weather-input" placeholder="Sunny, cloudy...">

                <label class="mac-label">üè∑Ô∏è Tags:</label>
                <div class="tag-input">
                    <input type="text" class="mac-input" id="tag-input" placeholder="Add tag...">
                    <button class="mac-button" onclick="addTag()">‚ûï</button>
                </div>
                <div id="tags-container"></div>

                <label class="mac-label">üñºÔ∏è Images:</label>
                <input type="file" accept="image/*" multiple onchange="handleImages(event)" style="margin-bottom: 12px;">
                <div id="image-previews"></div>

                <div class="audio-recorder">
                    <label class="mac-label">üé§ Audio Note:</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <button class="mac-button" id="record-btn" onclick="toggleRecording()">‚óè Record</button>
                        <button class="mac-button" id="stop-btn" onclick="stopRecording()" disabled>‚ñ† Stop</button>
                        <span id="recording-status">Ready to record</span>
                    </div>
                    <div id="audio-preview"></div>
                </div>

                <button class="mac-button mac-button-primary" onclick="saveEntry()" id="save-btn">üíæ Save</button>
                <button class="mac-button delete-button hidden" onclick="deleteCurrentEntry()" id="delete-btn">üóëÔ∏è Delete</button>
                <button class="mac-button" onclick="cancelEdit()">Cancel</button>
            </div>
        </div>

        <div class="mac-window hidden" id="time-event-window">
            <div class="mac-title-bar">Time Log</div>
            <div class="mac-content">
                <label class="mac-label">Duration:</label>
                <div class="duration-selector" id="duration-selector">
                    <!-- Options will be populated from settings -->
                </div>

                <label class="mac-label">Activity:</label>
                <div class="activity-selector" id="activity-selector">
                    <!-- Options will be populated from settings -->
                </div>

                <button class="mac-button mac-button-primary" onclick="saveTimeEvent()">üíæ Create Event</button>
                <button class="mac-button" onclick="cancelTimeEvent()">Cancel</button>
            </div>
        </div>

        <div class="mac-window hidden" id="track-window">
            <div class="mac-title-bar">Track</div>
            <div class="mac-content">
                <label class="mac-label">Category:</label>
                <div class="track-category-selector" id="track-category-selector">
                    <!-- Options will be populated from settings -->
                </div>

                <div id="track-item-section" class="hidden">
                    <label class="mac-label" id="track-item-label">Select Item:</label>
                    <div class="track-item-selector" id="track-item-selector">
                        <!-- Options will be populated from settings -->
                    </div>
                </div>

                <button class="mac-button mac-button-primary" onclick="saveTrackEvent()" id="track-save-btn">üíæ Create Event</button>
                <button class="mac-button" onclick="cancelTrackEvent()">Cancel</button>
            </div>
        </div>

        <div class="mac-window hidden" id="spent-window">
            <div class="mac-title-bar">Spent</div>
            <div class="mac-content">
                <label class="mac-label">Description:</label>
                <input type="text" class="mac-input" id="spent-description" placeholder="What did you spend on?">

                <label class="mac-label">Amount:</label>
                <div class="spent-form">
                    <input type="number" class="mac-input" id="spent-amount" placeholder="0.00" step="0.01">
                    <select class="mac-input" id="spent-currency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                    </select>
                </div>

                <label class="mac-label">Category:</label>
                <input type="text" class="mac-input" id="spent-category" placeholder="Food, Transport, etc.">

                <button class="mac-button mac-button-primary" onclick="saveSpentEvent()">üíæ Save Expense</button>
                <button class="mac-button" onclick="cancelSpentEvent()">Cancel</button>
            </div>
        </div>

        <div class="mac-window hidden" id="settings-window">
            <div class="mac-title-bar">Settings</div>
            <div class="mac-content">
                <div class="settings-section">
                    <h3>Time Event Durations</h3>
                    <div id="duration-config-container">
                        <!-- Duration configuration will be populated here -->
                    </div>
                    <button class="mac-button" onclick="addNewDuration()" style="margin-top: 10px;">‚ûï Add Duration</button>
                </div>

                <div class="settings-section">
                    <h3>Time Event Activities</h3>
                    <div id="activity-config-container">
                        <!-- Activity configuration will be populated here -->
                    </div>
                    <button class="mac-button" onclick="addNewActivity()" style="margin-top: 10px;">‚ûï Add Activity</button>
                </div>

                <div class="settings-section">
                    <h3>Track Categories</h3>
                    <div id="track-category-config-container">
                        <!-- Track category configuration will be populated here -->
                    </div>
                    <button class="mac-button" onclick="addNewTrackCategory()" style="margin-top: 10px;">‚ûï Add Category</button>
                </div>

                <button class="mac-button mac-button-primary" onclick="saveSettings()">üíæ Save Settings</button>
                <button class="mac-button" onclick="cancelSettings()">Cancel</button>
            </div>
        </div>

        <div class="mac-window hidden" id="stats-window">
            <div class="mac-title-bar">Statistics</div>
            <div class="mac-content stats-panel">
                <div id="stats-container">
                    <!-- Statistics will be populated here -->
                </div>
                <button class="mac-button" onclick="toggleStats()" style="margin-top: 15px;">Close</button>
            </div>
        </div>

        <div id="timeline-container"></div>

        <div class="mac-window hidden" id="empty-state">
            <div class="mac-content empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                <p><strong>No entries yet</strong></p>
                <p style="color: #666; margin-top: 8px;">Create your first entry</p>
            </div>
        </div>
    </div>

    <div class="footer hidden" id="footer">
        <div class="footer-filters">
            <input type="text" class="search-input" id="search-input" placeholder="üîç Search entries...">
            <select class="filter-select" id="date-filter">
                <option value="all">All dates</option>
                <option value="today">Today</option>
                <option value="week">This week</option>
                <option value="month">This month</option>
            </select>
            <select class="filter-select" id="location-filter">
                <option value="all">All locations</option>
            </select>
            <button class="mac-button" onclick="clearFilters()">Clear filters</button>
        </div>
        <div class="footer-controls">
            <button class="mac-button" onclick="exportCSV()">üìä CSV</button>
            <button class="mac-button" onclick="exportICS()">üìÖ iCal</button>
            <button class="mac-button" onclick="exportJSON()">üìÅ JSON</button>
            <button class="mac-button" onclick="toggleStats()">üìà Stats</button>
            <button class="mac-button" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
        </div>
    </div>

    <!-- Modal for enlarged image -->
    <div class="modal-overlay hidden" id="image-modal">
        <div class="modal-content image-modal">
            <button class="modal-close" onclick="closeModal('image-modal')">‚úï</button>
            <img id="modal-image" src="" alt="">
        </div>
    </div>

    <!-- Modal for enlarged map -->
    <div class="modal-overlay hidden" id="map-modal">
        <div class="modal-content map-modal">
            <button class="modal-close" onclick="closeModal('map-modal')">‚úï</button>
            <div id="modal-map"></div>
        </div>
    </div>
    
    <!-- ******** COMIENZA EL C√ìDIGO DE FIREBASE ******** -->

    <!-- Importar las librer√≠as de Firebase (las herramientas que necesitamos) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // Tu c√≥digo de configuraci√≥n de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAb-MLu8atl5hruOPLDhgftjkjc_1M2038",
        authDomain: "breadcrumbs-8b59e.firebaseapp.com",
        projectId: "breadcrumbs-8b59e",
        storageBucket: "breadcrumbs-8b59e.firebasestorage.app",
        messagingSenderId: "912286191427",
        appId: "1:912286191427:web:e78b665df6a6ff6d8529f6",
        measurementId: "G-GZYTDYNSRB"
      };

      // Inicializar (conectar) Firebase
      firebase.initializeApp(firebaseConfig);

      // Preparar la base de datos que usaremos
      const db = firebase.firestore();

    </script>
    
    <!-- ******** TERMINA EL C√ìDIGO DE FIREBASE ******** -->


    <script>
        const WEATHER_API_KEY = '317f7bcb07cf05e2c6265176c502a4bb';
        
        let entries = [];
        let currentImages = [];
        let currentCoords = null;
        let editingEntryId = null;
        let currentTags = [];
        let currentMood = null;
        let isDarkMode = false;
        let selectedDuration = null;
        let selectedActivity = null;
        let selectedTrackCategory = null;
        let selectedTrackItem = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentAudio = null;
        let collapsedDays = new Set();

        // Default settings
        let settings = {
            durations: [
                { label: "15 min", value: 15 },
                { label: "30 min", value: 30 },
                { label: "1 hour", value: 60 },
                { label: "2 hours", value: 120 },
                { label: "3 hours", value: 180 }
            ],
            activities: [
                { label: "Reading", icon: "üìñ" },
                { label: "Exercise", icon: "üí™" },
                { label: "Work", icon: "üíº" },
                { label: "Cleaning", icon: "üßπ" },
                { label: "Errands", icon: "üõí" }
            ],
            trackCategories: [
                {
                    name: "Food",
                    icon: "üçΩÔ∏è",
                    items: [
                        { name: "Paella", icon: "ü•ò" },
                        { name: "Tortellini", icon: "üçù" },
                        { name: "Fish", icon: "üêü" }
                    ]
                },
                {
                    name: "Exercise",
                    icon: "üí™",
                    items: [
                        { name: "Running", icon: "üèÉ" },
                        { name: "Yoga", icon: "üßò" },
                        { name: "Swimming", icon: "üèä" }
                    ]
                }
            ]
        };

        // --- NUEVA FUNCI√ìN loadData() CON FIREBASE ---
        // Carga los datos desde la base de datos de Firebase en la nube
        function loadData() {
            console.log("Cargando datos desde Firebase...");
            
            // 1. Pedimos a Firebase todas las entradas de la colecci√≥n "entries"
            // 2. Las ordenamos por "timestamp" en orden descendente (las m√°s nuevas primero)
            db.collection("entries").orderBy("timestamp", "desc").get()
                .then((querySnapshot) => {
                    // "querySnapshot" es la respuesta de Firebase con todas nuestras entradas
                    
                    entries = []; // Vaciamos la lista local primero
                    
                    querySnapshot.forEach((doc) => {
                        // Por cada "documento" (entrada) que encontramos en la nube...
                        // ...lo a√±adimos a nuestra lista local "entries"
                        let entry = doc.data(); // doc.data() es la entrada (nota, lugar, etc.)
                        entry.id = doc.id;      // ¬°IMPORTANTE! Guardamos el ID √∫nico que Firebase le dio
                        entries.push(entry);
                    });
                    
                    console.log(`¬°Carga completa! ${entries.length} entradas encontradas.`);

                    // A partir de aqu√≠, el resto de la funci√≥n se mantiene para configurar la UI
                    // con los datos que acabamos de cargar.
                    
                    const theme = localStorage.getItem('timeline-theme');
                    if (theme === 'dark') {
                        document.body.classList.add('dark-mode');
                        isDarkMode = true;
                        document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
                    }
                    
                    const savedSettings = localStorage.getItem('timeline-settings');
                    if (savedSettings) {
                        settings = JSON.parse(savedSettings);
                    }
                    
                    const savedCollapsedDays = localStorage.getItem('timeline-collapsed-days');
                    if (savedCollapsedDays) {
                        collapsedDays = new Set(JSON.parse(savedCollapsedDays));
                    }
                    
                    renderTimeline();
                    updateLocationFilter();
                    updateDurationSelector();
                    updateActivitySelector();
                    updateTrackCategorySelector();
                    
                    if (entries.length > 0) {
                        document.getElementById('footer').classList.remove('hidden');
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar datos: ", error);
                    showNotification("Error al cargar las entradas", true);
                });
        }

        // Ya no necesitamos saveData() porque guardamos directamente en Firebase.
        
        function saveSettings() {
            // Las configuraciones las mantenemos en localStorage por simplicidad
            localStorage.setItem('timeline-settings', JSON.stringify(settings));
            updateDurationSelector();
            updateActivitySelector();
            updateTrackCategorySelector();
            toggleSettings();
            showNotification('Settings saved');
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('timeline-theme', isDarkMode ? 'dark' : 'light');
        }

        function toggleForm() {
            const form = document.getElementById('form-window');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                clearForm();
            }
        }

        function toggleTimeEventForm() {
            const form = document.getElementById('time-event-window');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                clearTimeEventForm();
            }
        }

        function toggleTrackForm() {
            const form = document.getElementById('track-window');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                clearTrackForm();
            }
        }

        function toggleSpentForm() {
            const form = document.getElementById('spent-window');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                clearSpentForm();
            }
        }

        function toggleSettings() {
            const settingsWindow = document.getElementById('settings-window');
            settingsWindow.classList.toggle('hidden');
            if (!settingsWindow.classList.contains('hidden')) {
                renderSettings();
            }
        }

        function toggleStats() {
            const statsWindow = document.getElementById('stats-window');
            statsWindow.classList.toggle('hidden');
            if (!statsWindow.classList.contains('hidden')) {
                renderStats();
            }
        }

        function clearForm() {
            document.getElementById('note-input').value = '';
            document.getElementById('location-input').value = '';
            document.getElementById('weather-input').value = '';
            document.getElementById('tag-input').value = '';
            currentImages = [];
            currentCoords = null;
            editingEntryId = null;
            currentTags = [];
            currentAudio = null;
            currentMood = null;
            document.getElementById('image-previews').innerHTML = '';
            document.getElementById('tags-container').innerHTML = '';
            document.getElementById('audio-preview').innerHTML = '';
            document.getElementById('delete-btn').classList.add('hidden');
            document.getElementById('save-btn').textContent = 'üíæ Save';
            document.getElementById('record-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('recording-status').textContent = 'Ready to record';
            const mapContainer = document.getElementById('form-map');
            if (mapContainer) {
                mapContainer.classList.add('hidden');
                mapContainer.innerHTML = '';
            }
            
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function clearTimeEventForm() {
            selectedDuration = null;
            selectedActivity = null;
            
            document.querySelectorAll('.duration-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.activity-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function clearTrackForm() {
            selectedTrackCategory = null;
            selectedTrackItem = null;
            
            document.querySelectorAll('.track-category-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.track-item-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.getElementById('track-item-section').classList.add('hidden');
            document.getElementById('track-save-btn').disabled = true;
        }

        function clearSpentForm() {
            document.getElementById('spent-description').value = '';
            document.getElementById('spent-amount').value = '';
            document.getElementById('spent-category').value = '';
        }

        function cancelEdit() {
            clearForm();
            toggleForm();
        }

        function cancelTimeEvent() {
            clearTimeEventForm();
            toggleTimeEventForm();
        }

        function cancelTrackEvent() {
            clearTrackForm();
            toggleTrackForm();
        }

        function cancelSpentEvent() {
            clearSpentForm();
            toggleSpentEvent();
        }

        function cancelSettings() {
            toggleSettings();
        }

        function selectMood(mood) {
            currentMood = mood;
            
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        async function toggleRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        currentAudio = URL.createObjectURL(audioBlob);
                        document.getElementById('audio-preview').innerHTML = `
                            <audio controls src="${currentAudio}"></audio>
                            <button class="mac-button delete-button" onclick="removeAudio()" style="margin-top: 5px;">Remove Audio</button>
                        `;
                    };
                    
                    mediaRecorder.start();
                    document.getElementById('record-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('recording-status').innerHTML = '<span class="recording-indicator"></span>Recording...';
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    showNotification('Microphone access denied', true);
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('record-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('recording-status').textContent = 'Recording saved';
                
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        function removeAudio() {
            currentAudio = null;
            document.getElementById('audio-preview').innerHTML = '';
        }

        async function getGPS() {
            const btn = document.getElementById('gps-btn');
            btn.textContent = 'üåç Getting location...';
            btn.disabled = true;

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });

                const { latitude, longitude } = position.coords;
                currentCoords = { lat: latitude, lng: longitude };
                
                const locationName = await getLocationName(latitude, longitude);
                document.getElementById('location-input').value = locationName;
                
                showNotification('Location found: ' + locationName);
                
                const mapContainer = document.getElementById('form-map');
                mapContainer.classList.remove('hidden');
                renderMiniMap(mapContainer, latitude, longitude, 'Current Location');
                
            } catch (error) {
                console.error('GPS error:', error);
                showNotification('Failed to get location: ' + error.message, true);
                document.getElementById('location-input').value = 'GPS failed';
            } finally {
                btn.textContent = 'üåç Use GPS';
                btn.disabled = false;
            }
        }

        async function getLocationName(lat, lng) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data.locality) {
                    return `${data.locality}, ${data.countryName}`;
                } else if (data.city) {
                    return `${data.city}, ${data.countryName}`;
                } else {
                    return `${data.countryName}`;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function renderMiniMap(container, lat, lng, title) {
            container.innerHTML = '';
            const map = L.map(container).setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup(title).openPopup();
        }

        function handleImages(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImages.push(e.target.result);
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderImagePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = '';
            currentImages.forEach((img, index) => {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.innerHTML = `
                    <img src="${img}" alt="Preview ${index + 1}">
                    <div class="image-remove" onclick="removeImage(${index})">√ó</div>
                `;
                container.appendChild(preview);
            });
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            renderImagePreviews();
        }

        function addTag() {
            const tagInput = document.getElementById('tag-input');
            const tag = tagInput.value.trim();
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTags();
                tagInput.value = '';
            }
        }

        function renderTags() {
            const container = document.getElementById('tags-container');
            container.innerHTML = '';
            currentTags.forEach((tag, index) => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `${tag} <span onclick="removeTag(${index})" style="cursor: pointer; margin-left: 5px;">√ó</span>`;
                container.appendChild(tagElement);
            });
        }

        function removeTag(index) {
            currentTags.splice(index, 1);
            renderTags();
        }

        // --- FUNCI√ìN saveEntry() ACTUALIZADA CON FIREBASE ---
        // Guarda una entrada de tipo "Breadcrumb"
        function saveEntry() {
            const note = document.getElementById('note-input').value.trim();
            if (!note) {
                showNotification('Please enter a note', true);
                return;
            }
            
            const entry = {
                timestamp: Date.now(),
                type: 'manual-entry',
                note: note,
                location: document.getElementById('location-input').value.trim(),
                weather: document.getElementById('weather-input').value.trim(),
                mood: currentMood,
                tags: [...currentTags],
                images: [], // Las im√°genes las manejaremos en un paso futuro
                audio: null, // El audio lo manejaremos en un paso futuro
                coords: currentCoords
            };

            // Llamamos a una funci√≥n gen√©rica para guardar en Firebase
            saveEntryToFirebase(entry, editingEntryId);
        }

        // --- FUNCI√ìN gen√©rica para guardar/actualizar cualquier entrada en Firebase ---
        function saveEntryToFirebase(entryData, entryId) {
            const button = event.target;
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'üíæ Guardando...';

            if (entryId) {
                // Si hay un ID, estamos ACTUALIZANDO una entrada existente
                db.collection("entries").doc(entryId).update(entryData)
                    .then(() => {
                        showNotification('Entrada actualizada');
                        loadData(); // Recargamos todo desde la nube
                        cancelActiveForms();
                    })
                    .catch(handleFirebaseError)
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            } else {
                // Si no hay ID, estamos CREANDO una nueva entrada
                db.collection("entries").add(entryData)
                    .then(() => {
                        showNotification('Entrada guardada');
                        loadData(); // Recargamos todo desde la nube
                        cancelActiveForms();
                    })
                    .catch(handleFirebaseError)
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            }
        }
        
        function handleFirebaseError(error) {
            console.error("Error con Firebase: ", error);
            showNotification('Hubo un error al guardar', true);
        }

        function cancelActiveForms() {
            if (!document.getElementById('form-window').classList.contains('hidden')) toggleForm();
            if (!document.getElementById('time-event-window').classList.contains('hidden')) toggleTimeEventForm();
            if (!document.getElementById('track-window').classList.contains('hidden')) toggleTrackForm();
            if (!document.getElementById('spent-window').classList.contains('hidden')) toggleSpentForm();
            const editForm = document.querySelector('.edit-form-container');
            if (editForm) editForm.remove();
        }


        function updateDurationSelector() {
            const container = document.getElementById('duration-selector');
            container.innerHTML = '';
            settings.durations.forEach(duration => {
                const option = document.createElement('div');
                option.className = 'duration-option';
                option.textContent = duration.label;
                option.onclick = () => selectDuration(duration);
                container.appendChild(option);
            });
        }

        function selectDuration(duration) {
            selectedDuration = duration;
            document.querySelectorAll('.duration-option').forEach(option => option.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function updateActivitySelector() {
            const container = document.getElementById('activity-selector');
            container.innerHTML = '';
            settings.activities.forEach(activity => {
                const option = document.createElement('div');
                option.className = 'activity-option';
                option.innerHTML = `<span class="activity-icon">${activity.icon}</span> ${activity.label}`;
                option.onclick = () => selectActivity(activity);
                container.appendChild(option);
            });
        }

        function selectActivity(activity) {
            selectedActivity = activity;
            document.querySelectorAll('.activity-option').forEach(option => option.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // --- FUNCI√ìN saveTimeEvent() ACTUALIZADA CON FIREBASE ---
        function saveTimeEvent() {
            if (!selectedDuration || !selectedActivity) {
                showNotification('Please select both duration and activity', true);
                return;
            }
            const entry = {
                timestamp: Date.now(),
                type: 'time-event',
                duration: selectedDuration.value,
                durationLabel: selectedDuration.label,
                activity: selectedActivity.label,
                activityIcon: selectedActivity.icon,
                note: `${selectedActivity.icon} ${selectedActivity.label} for ${selectedDuration.label}`
            };
            saveEntryToFirebase(entry);
        }

        function updateTrackCategorySelector() {
            const container = document.getElementById('track-category-selector');
            container.innerHTML = '';
            settings.trackCategories.forEach(category => {
                const option = document.createElement('div');
                option.className = 'track-category-option';
                option.innerHTML = `<span>${category.icon}</span> ${category.name}`;
                option.onclick = () => selectTrackCategory(category);
                container.appendChild(option);
            });
        }

        function selectTrackCategory(category) {
            selectedTrackCategory = category;
            selectedTrackItem = null;
            document.querySelectorAll('.track-category-option').forEach(option => option.classList.remove('selected'));
            event.target.classList.add('selected');
            
            const itemSection = document.getElementById('track-item-section');
            itemSection.classList.remove('hidden');
            
            const itemContainer = document.getElementById('track-item-selector');
            itemContainer.innerHTML = '';
            category.items.forEach(item => {
                const option = document.createElement('div');
                option.className = 'track-item-option';
                option.innerHTML = `<span>${item.icon}</span> ${item.name}`;
                option.onclick = () => selectTrackItem(item);
                itemContainer.appendChild(option);
            });
            document.getElementById('track-save-btn').disabled = false;
        }

        function selectTrackItem(item) {
            selectedTrackItem = item;
            document.querySelectorAll('.track-item-option').forEach(option => option.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // --- FUNCI√ìN saveTrackEvent() ACTUALIZADA CON FIREBASE ---
        function saveTrackEvent() {
            if (!selectedTrackCategory || !selectedTrackItem) {
                showNotification('Please select both category and item', true);
                return;
            }
            const entry = {
                timestamp: Date.now(),
                type: 'track-event',
                trackCategory: selectedTrackCategory.name,
                trackCategoryIcon: selectedTrackCategory.icon,
                trackItem: selectedTrackItem.name,
                trackItemIcon: selectedTrackItem.icon,
                note: `${selectedTrackCategory.icon} ${selectedTrackCategory.name}: ${selectedTrackItem.icon} ${selectedTrackItem.name}`
            };
            saveEntryToFirebase(entry);
        }

        // --- FUNCI√ìN saveSpentEvent() ACTUALIZADA CON FIREBASE ---
        function saveSpentEvent() {
            const description = document.getElementById('spent-description').value.trim();
            const amount = document.getElementById('spent-amount').value.trim();
            if (!description || !amount) {
                showNotification('Please enter both description and amount', true);
                return;
            }
            const entry = {
                timestamp: Date.now(),
                type: 'spent-event',
                spentDescription: description,
                amount: parseFloat(amount).toFixed(2),
                currency: document.getElementById('spent-currency').value,
                spentCategory: document.getElementById('spent-category').value.trim() || 'Uncategorized',
                note: `üí∞ Spent ${document.getElementById('spent-currency').value} ${parseFloat(amount).toFixed(2)} on ${description}`
            };
            saveEntryToFirebase(entry);
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const emptyState = document.getElementById('empty-state');
            
            if (entries.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');
            
            const entriesByDay = {};
            entries.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dayKey = date.toDateString();
                if (!entriesByDay[dayKey]) entriesByDay[dayKey] = [];
                entriesByDay[dayKey].push(entry);
            });
            
            const sortedDays = Object.keys(entriesByDay).sort((a, b) => new Date(b) - new Date(a));
            
            let timelineHTML = '<div class="timeline"><div class="timeline-line"></div>';
            sortedDays.forEach(day => {
                const dayEntries = entriesByDay[day];
                const date = new Date(day);
                const isCollapsed = collapsedDays.has(day);
                
                dayEntries.sort((a, b) => b.timestamp - a.timestamp);
                
                timelineHTML += `
                    <div class="day-block">
                        <div class="day-header" onclick="toggleDay('${day}')">
                            <span>${formatDate(date)}</span>
                            <span class="chevron ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                        </div>
                        <div class="day-content ${isCollapsed ? 'collapsed' : ''}">
                            ${dayEntries.map(entry => renderBreadcrumbEntry(entry)).join('')}
                        </div>
                    </div>
                `;
            });
            
            timelineHTML += '</div>';
            container.innerHTML = timelineHTML;
            
            entries.forEach(entry => {
                if (entry.coords) {
                    const mapContainer = document.querySelector(`[data-entry-id="${entry.id}"] .preview-map`);
                    if (mapContainer) {
                        mapContainer.innerHTML = '';
                        renderMiniMap(mapContainer, entry.coords.lat, entry.coords.lng, entry.location || 'Location');
                    }
                }
            });
        }

        function renderBreadcrumbEntry(entry) {
            const hasImages = entry.images && entry.images.length > 0;
            
            return `
                <div class="breadcrumb-entry ${entry.type || 'manual-entry'}" data-entry-id="${entry.id}">
                    <div class="breadcrumb-time">
                        ${formatTime(entry.timestamp)}
                        ${entry.mood ? `<span class="mood-display">${entry.mood}</span>` : ''}
                        ${entry.duration ? `<span class="time-event-indicator">${entry.duration} min</span>` : ''}
                        ${entry.amount ? `<span class="spent-amount">${entry.currency || 'USD'} ${entry.amount}</span>` : ''}
                    </div>
                    
                    <div class="breadcrumb-content">
                        <div class="breadcrumb-meta">
                            ${entry.location ? `<span>üìç ${entry.location}</span>` : ''}
                            ${entry.weather ? `<span>‚òÅÔ∏è ${entry.weather}</span>` : ''}
                        </div>
                        
                        <div class="breadcrumb-note" id="note-${entry.id}">
                            ${entry.note || ''}
                            ${entry.trackItem ? `<br><small>üìì ${entry.trackCategory} - ${entry.trackItem}</small>` : ''}
                            ${entry.activity ? `<br><small>‚è∞ ${entry.activity}</small>` : ''}
                            ${entry.spentDescription ? `<br><small>üí∞ ${entry.spentDescription}</small>` : ''}
                        </div>
                        
                        ${entry.note && entry.note.length > 150 ? `<button class="read-more-btn" onclick="toggleReadMore('${entry.id}')">Read more</button>` : ''}
                        ${hasImages ? `<button class="toggle-preview-btn" onclick="toggleImagePreview('${entry.id}')">üëÅÔ∏è Show Images (${entry.images.length})</button><div class="breadcrumb-preview" id="preview-${entry.id}">${entry.images.map((img, index) => `<div class="preview-item" onclick="openImageModal('${img}')"><img src="${img}" alt="Image ${index + 1}"></div>`).join('')}</div>` : ''}
                        ${entry.audio ? `<button class="audio-button" onclick="playAudio('${entry.audio}', '${entry.id}')">üîä Play</button><audio id="audio-${entry.id}" src="${entry.audio}" preload="none"></audio>` : ''}
                    </div>
                    
                    ${entry.coords ? `<div class="preview-map" onclick="openMapModal(${entry.coords.lat}, ${entry.coords.lng}, '${entry.location}')"></div>` : ''}
                    <button class="edit-button" onclick="editEntry('${entry.id}')">‚úèÔ∏è Edit</button>
                </div>
            `;
        }

        function toggleDay(day) {
            if (collapsedDays.has(day)) {
                collapsedDays.delete(day);
            } else {
                collapsedDays.add(day);
            }
            // Guardamos el estado de los d√≠as colapsados en localStorage
            localStorage.setItem('timeline-collapsed-days', JSON.stringify([...collapsedDays]));
            renderTimeline();
        }

        function toggleReadMore(entryId) {
            const noteElement = document.getElementById(`note-${entryId}`);
            const button = noteElement.nextElementSibling;
            noteElement.classList.toggle('expanded');
            button.textContent = noteElement.classList.contains('expanded') ? 'Read less' : 'Read more';
        }

        function toggleImagePreview(entryId) {
            const preview = document.getElementById(`preview-${entryId}`);
            const button = preview.previousElementSibling;
            preview.classList.toggle('show-preview');
            button.textContent = preview.classList.contains('show-preview') ? `üëÅÔ∏è Hide Images` : `üëÅÔ∏è Show Images`;
        }

        function playAudio(audioUrl, entryId) {
            const audio = document.getElementById(`audio-${entryId}`);
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            editingEntryId = id;
            
            // Limpiar formularios existentes
            document.getElementById('edit-forms-container').innerHTML = '';
            
            const editForm = document.createElement('div');
            editForm.className = 'mac-window edit-form-container';
            editForm.innerHTML = `
                <div class="mac-title-bar">Edit Breadcrumb</div>
                <div class="mac-content">
                    <label class="mac-label">Note:</label>
                    <textarea class="mac-textarea edit-note-input">${entry.note || ''}</textarea>
                    
                    <label class="mac-label">üìç Location:</label>
                    <input type="text" class="mac-input edit-location-input" value="${entry.location || ''}">

                    <button class="mac-button mac-button-primary" onclick="saveEditedEntry('${id}')">üíæ Save Changes</button>
                    <button class="mac-button delete-button" onclick="deleteEntry('${id}')">üóëÔ∏è Delete</button>
                    <button class="mac-button" onclick="cancelEditEntry('${id}')">Cancel</button>
                </div>
            `;
            
            const entryElement = document.querySelector(`[data-entry-id="${id}"]`);
            if (entryElement && entryElement.parentNode) {
                entryElement.parentNode.insertBefore(editForm, entryElement.nextSibling);
            }
        }

        function saveEditedEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            // Creamos un objeto solo con los campos que se pueden editar en este formulario simple
            const updatedData = {
                note: document.querySelector('.edit-note-input').value.trim(),
                location: document.querySelector('.edit-location-input').value.trim()
            };

            // Usamos la funci√≥n gen√©rica para actualizar en Firebase
            saveEntryToFirebase(updatedData, id);
        }
        
        // --- FUNCI√ìN deleteEntry() ACTUALIZADA CON FIREBASE ---
        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                db.collection("entries").doc(id).delete()
                    .then(() => {
                        showNotification('Entrada eliminada');
                        loadData(); // Recargamos la lista desde la nube
                        cancelActiveForms();
                    })
                    .catch(handleFirebaseError);
            }
        }


        function cancelEditEntry(id) {
            const editForm = document.querySelector(`.edit-form-container`);
            if (editForm) {
                editForm.remove();
            }
            editingEntryId = null;
        }

        function openImageModal(imageSrc) {
            document.getElementById('modal-image').src = imageSrc;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        function openMapModal(lat, lng, title) {
            const modal = document.getElementById('map-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                const mapContainer = document.getElementById('modal-map');
                mapContainer.innerHTML = '';
                const map = L.map(mapContainer).setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
                L.marker([lat, lng]).addTo(map).bindPopup(title || 'Location').openPopup();
            }, 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function showNotification(message, isError = false) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) notification.parentNode.removeChild(notification);
            }, 3000);
        }

        function renderSettings() { /* ... el resto de funciones se mantienen igual ... */ }
        function renderDurationConfig() { /* ... */ }
        function updateDurationLabel(index, value) { settings.durations[index].label = value; }
        function updateDurationValue(index, value) { settings.durations[index].value = parseInt(value) || 0; }
        function removeDuration(index) { settings.durations.splice(index, 1); renderDurationConfig(); }
        function addNewDuration() { settings.durations.push({ label: 'New', value: 30 }); renderDurationConfig(); }
        function renderActivityConfig() { /* ... */ }
        function updateActivityIcon(index, value) { settings.activities[index].icon = value; }
        function updateActivityLabel(index, value) { settings.activities[index].label = value; }
        function removeActivity(index) { settings.activities.splice(index, 1); renderActivityConfig(); }
        function addNewActivity() { settings.activities.push({ label: 'New', icon: '‚≠ê' }); renderActivityConfig(); }
        function renderTrackCategoryConfig() { /* ... */ }
        function updateTrackCategoryName(index, value) { settings.trackCategories[index].name = value; }
        function updateTrackCategoryIcon(index, value) { settings.trackCategories[index].icon = value; }
        function removeTrackCategory(index) { settings.trackCategories.splice(index, 1); renderTrackCategoryConfig(); }
        function addNewTrackCategory() { settings.trackCategories.push({ name: 'New', icon: '‚≠ê', items: [] }); renderTrackCategoryConfig(); }
        function updateTrackItemName(cIndex, iIndex, value) { settings.trackCategories[cIndex].items[iIndex].name = value; }
        function updateTrackItemIcon(cIndex, iIndex, value) { settings.trackCategories[cIndex].items[iIndex].icon = value; }
        function removeTrackItem(cIndex, iIndex) { settings.trackCategories[cIndex].items.splice(iIndex, 1); renderTrackCategoryConfig(); }
        function addNewTrackItem(cIndex) { settings.trackCategories[cIndex].items.push({ name: 'New', icon: '‚≠ê' }); renderTrackCategoryConfig(); }
        function renderStats() { /* ... */ }
        function updateLocationFilter() { /* ... */ }
        function clearFilters() { /* ... */ }
        function exportCSV() { /* ... */ }
        function exportJSON() { /* ... */ }
        function exportICS() { /* ... */ }
        function formatDateForICS(date) { return date.toISOString().replace(/[-:]/g, '').replace(/\..+/, ''); }
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
