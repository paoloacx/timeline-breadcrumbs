<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breadcrumbs Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: repeating-linear-gradient(
                0deg,
                #c0c0c0,
                #c0c0c0 1px,
                #d0d0d0 1px,
                #d0d0d0 2px
            );
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .mac-window {
            background: white;
            border: 3px solid #000;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .mac-title-bar {
            background: #000;
            color: white;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .mac-content {
            padding: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mac-button {
            background: #ddd;
            border: 3px outset #fff;
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .mac-button:hover {
            background: #eee;
        }

        .mac-button:active {
            border-style: inset;
        }

        .mac-button-primary {
            background: #000;
            color: white;
        }

        .mac-input,
        .mac-textarea {
            width: 100%;
            border: 2px inset #999;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .mac-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .mac-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .timeline-entry {
            background: #f0f0f0;
            border: 3px ridge #999;
            padding: 16px;
            margin-bottom: 16px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #999;
        }

        .timeline-date {
            font-weight: bold;
            font-size: 13px;
        }

        .timeline-note {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .timeline-meta {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .image-preview {
            display: inline-block;
            width: 80px;
            height: 80px;
            border: 2px solid #000;
            margin: 4px;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: #000;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            color: white;
            padding: 12px 20px;
            border-top: 3px solid #666;
            display: flex;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.3);
        }

        .footer .mac-button {
            margin: 0;
        }

        .mini-map {
            width: 100%;
            height: 200px;
            border: 3px solid #000;
            margin-top: 12px;
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mac-window">
            <div class="mac-title-bar">Breadcrumbs Timeline</div>
            <div class="mac-content">
                <div id="buttons-container">
                    <button class="mac-button mac-button-primary" onclick="toggleForm()">‚ûï Nueva Entrada</button>
                </div>
            </div>
        </div>

        <div class="mac-window hidden" id="form-window">
            <div class="mac-title-bar">Nueva Anotaci√≥n</div>
            <div class="mac-content">
                <label class="mac-label">Nota:</label>
                <textarea class="mac-textarea" id="note-input" placeholder="¬øQu√© est√° pasando?"></textarea>

                <label class="mac-label">üìç Ubicaci√≥n:</label>
                <input type="text" class="mac-input" id="location-input" placeholder="Lugar">
                <button class="mac-button" onclick="getGPS()" id="gps-btn">üåç Usar GPS</button>
                <div id="form-map" class="mini-map" style="display: none;"></div>

                <label class="mac-label">‚òÅÔ∏è Clima:</label>
                <input type="text" class="mac-input" id="weather-input" placeholder="Soleado, nublado...">

                <label class="mac-label">üñºÔ∏è Im√°genes:</label>
                <input type="file" accept="image/*" multiple onchange="handleImages(event)" style="margin-bottom: 12px;">
                <div id="image-previews"></div>

                <button class="mac-button mac-button-primary" onclick="saveEntry()">üíæ Guardar</button>
                <button class="mac-button" onclick="toggleForm()">Cancelar</button>
            </div>
        </div>

        <div id="timeline-container"></div>

        <div class="mac-window hidden" id="empty-state">
            <div class="mac-content empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                <p><strong>No hay entradas</strong></p>
                <p style="color: #666; margin-top: 8px;">Crea tu primera anotaci√≥n</p>
            </div>
        </div>
    </div>

    <div class="footer" id="footer" style="display: none;">
        <button class="mac-button" onclick="exportCSV()">üíæ Exportar CSV</button>
        <button class="mac-button" onclick="exportICS()">üìÖ Exportar iCal</button>
    </div>

    <script>
        let entries = [];
        let currentImages = [];
        let currentCoords = null;

        // Cargar datos
        function loadData() {
            const saved = localStorage.getItem('timeline-entries');
            if (saved) {
                entries = JSON.parse(saved);
            }
            renderTimeline();
        }

        // Guardar datos
        function saveData() {
            localStorage.setItem('timeline-entries', JSON.stringify(entries));
        }

        // Toggle formulario
        function toggleForm() {
            const form = document.getElementById('form-window');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                document.getElementById('note-input').value = '';
                document.getElementById('location-input').value = '';
                document.getElementById('weather-input').value = '';
                currentImages = [];
                currentCoords = null;
                document.getElementById('image-previews').innerHTML = '';
                const mapContainer = document.getElementById('form-map');
                if (mapContainer) {
                    mapContainer.style.display = 'none';
                    mapContainer.innerHTML = '';
                }
            }
        }

        // GPS
        function getGPS() {
            const btn = document.getElementById('gps-btn');
            btn.textContent = '‚è≥ Buscando...';
            btn.disabled = true;

            if (!navigator.geolocation) {
                alert('Geolocalizaci√≥n no disponible');
                btn.textContent = 'üåç Usar GPS';
                btn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    currentCoords = { lat, lon };
                    document.getElementById('location-input').value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    
                    // Mostrar minimapa
                    showMiniMap(lat, lon, 'form-map');
                    
                    btn.textContent = 'üåç Usar GPS';
                    btn.disabled = false;
                },
                (error) => {
                    alert('Error obteniendo ubicaci√≥n: ' + error.message);
                    btn.textContent = 'üåç Usar GPS';
                    btn.disabled = false;
                }
            );
        }

        // Mostrar minimapa con Leaflet (100% gratis, sin API key)
        function showMiniMap(lat, lon, containerId) {
            const mapContainer = document.getElementById(containerId);
            if (!mapContainer) return;

            mapContainer.innerHTML = '';
            mapContainer.style.display = 'block';

            // Crear mapa
            const map = L.map(containerId).setView([lat, lon], 13);

            // A√±adir capa de OpenStreetMap (gratis, sin API key)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // A√±adir marcador
            L.marker([lat, lon]).addTo(map);

            // Peque√±o retraso para que el mapa se renderice correctamente
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // Manejar im√°genes
        function handleImages(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImages.push(e.target.result);
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = currentImages.map((img, idx) => `
                <div class="image-preview">
                    <img src="${img}" alt="">
                    <div class="image-remove" onclick="removeImage(${idx})">‚úï</div>
                </div>
            `).join('');
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            renderImagePreviews();
        }

        // Guardar entrada
        function saveEntry() {
            const note = document.getElementById('note-input').value.trim();
            if (!note) {
                alert('Por favor escribe una nota');
                return;
            }

            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                note: note,
                location: document.getElementById('location-input').value,
                weather: document.getElementById('weather-input').value,
                images: [...currentImages],
                coords: currentCoords ? { ...currentCoords } : null
            };

            entries.unshift(entry);
            saveData();
            renderTimeline();
            toggleForm();
        }

        // Eliminar entrada
        function deleteEntry(id) {
            if (confirm('¬øEliminar esta entrada?')) {
                entries = entries.filter(e => e.id !== id);
                saveData();
                renderTimeline();
            }
        }

        // Formatear fecha
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const isToday = date.toDateString() === today.toDateString();
            const isYesterday = date.toDateString() === yesterday.toDateString();

            if (isToday) {
                return `Hoy ${date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (isYesterday) {
                return `Ayer ${date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                return date.toLocaleString('es', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // Renderizar timeline
        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const emptyState = document.getElementById('empty-state');
            const footer = document.getElementById('footer');

            if (entries.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                footer.style.display = 'none';
            } else {
                emptyState.classList.add('hidden');
                footer.style.display = 'flex';

                container.innerHTML = entries.map(entry => `
                    <div class="timeline-entry">
                        <div class="timeline-header">
                            <div class="timeline-date">${formatDate(entry.timestamp)}</div>
                            <button class="mac-button" onclick="deleteEntry(${entry.id})" style="padding: 4px 12px;">üóëÔ∏è</button>
                        </div>
                        <div class="timeline-note">${entry.note}</div>
                        ${entry.location ? `<div class="timeline-meta">üìç ${entry.location}</div>` : ''}
                        ${entry.weather ? `<div class="timeline-meta">‚òÅÔ∏è ${entry.weather}</div>` : ''}
                        ${entry.coords ? `<div id="map-${entry.id}" class="mini-map"></div>` : ''}
                        ${entry.images.length > 0 ? `
                            <div style="margin-top: 12px;">
                                ${entry.images.map(img => `
                                    <img src="${img}" style="width: 100px; height: 100px; object-fit: cover; border: 2px solid #000; margin: 4px; cursor: pointer;" onclick="window.open('${img}')">
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                // Renderizar mapas para entradas con coordenadas
                entries.forEach(entry => {
                    if (entry.coords) {
                        setTimeout(() => {
                            showMiniMap(entry.coords.lat, entry.coords.lon, `map-${entry.id}`);
                        }, 100);
                    }
                });
            }
        }

        // Exportar CSV
        function exportCSV() {
            const headers = ['Fecha y Hora', 'Nota', 'Ubicaci√≥n', 'Clima', 'Im√°genes'];
            const rows = entries.map(e => [
                new Date(e.timestamp).toLocaleString(),
                e.note,
                e.location || '',
                e.weather || '',
                e.images.length
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `breadcrumbs-${Date.now()}.csv`;
            a.click();
        }

        // Exportar iCal
        function exportICS() {
            const icsEvents = entries.map(e => {
                const date = new Date(e.timestamp);
                const dateStr = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                return `BEGIN:VEVENT
UID:${e.id}@breadcrumbs
DTSTAMP:${dateStr}
DTSTART:${dateStr}
SUMMARY:${e.note.substring(0, 50)}
DESCRIPTION:${e.note}
LOCATION:${e.location || ''}
END:VEVENT`;
            }).join('\n');

            const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Breadcrumbs Timeline//ES
${icsEvents}
END:VCALENDAR`;

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `breadcrumbs-${Date.now()}.ics`;
            a.click();
        }

        // Iniciar
        loadData();
    </script>
</body>
</html>